<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°ç™½ä¿¡ - ä¸»é¢˜èŠå¤©å®¤</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- LeanCloud SDK -->
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
  
  <!-- è‡ªå®šä¹‰é…ç½® -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#FF7E95', // ä¸»è‰²è°ƒï¼šå…”å­ç²‰
            secondary: '#A084DC', // è¾…åŠ©è‰²ï¼šæ·¡ç´«è‰²
            accent: '#93C5FD', // å¼ºè°ƒè‰²ï¼šå¤©ç©ºè“
            neutral: {
              100: '#F9FAFB',
              200: '#F3F4F6',
              300: '#E5E7EB',
              400: '#D1D5DB',
              500: '#9CA3AF',
              600: '#6B7280',
              700: '#4B5563',
              800: '#1F2937',
              900: '#111827',
            }
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .animate-fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .hover-scale {
        transition: transform 0.2s ease-in-out;
      }
      .hover-scale:hover {
        transform: scale(1.02);
      }
      .glass {
        backdrop-blur: 12px;
        -webkit-backdrop-blur: 12px;
      }
      .bubble-right {
        border-radius: 20px 20px 0 20px;
      }
      .bubble-left {
        border-radius: 20px 20px 20px 0;
      }
      .scroll-smooth {
        scroll-behavior: smooth;
      }
      .text-glow {
        text-shadow: 0 0 8px rgba(255, 126, 149, 0.6);
      }
      .bg-darken {
        background-color: rgba(0, 0, 0, 0.05);
      }
      .dark .bg-darken {
        background-color: rgba(255, 255, 255, 0.05);
      }
    }
  </style>
</head>

<body class="font-inter bg-gradient-to-br from-neutral-100 to-neutral-200 text-neutral-800 min-h-screen dark:bg-gradient-to-br from-neutral-900 to-neutral-800 dark:text-neutral-100 transition-colors duration-300">
  <!-- ç™»å½•æ¨¡æ€æ¡† -->
  <div id="login-modal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-neutral-800 rounded-xl w-full max-w-md mx-4 p-6 border border-neutral-200 dark:border-neutral-700/50 shadow-2xl animate-fade-in">
      <div class="text-center mb-6">
        <div class="w-16 h-16 mx-auto mb-2 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center shadow-lg">
          <i class="fa fa-user-circle text-white text-2xl"></i>
        </div>
        <h2 class="text-2xl font-bold bg-gradient-to-r from-primary to-secondary inline-block text-transparent bg-clip-text text-glow">å°ç™½ä¿¡</h2>
        <p class="text-neutral-500 dark:text-neutral-400 mt-1">è¯·ç™»å½•åå¼€å§‹èŠå¤©</p>
      </div>
      
      <div class="space-y-4">
        <div>
          <label for="login-userid" class="block text-sm font-medium mb-1">ç”¨æˆ·ID</label>
          <input type="text" id="login-userid" placeholder="è¯·è¾“å…¥ç”¨æˆ·ID" 
                class="w-full bg-neutral-100 dark:bg-neutral-700/50 border border-neutral-200 dark:border-neutral-600/50 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-primary/50 text-sm shadow-sm">
        </div>
        
        <div>
          <label for="login-password" class="block text-sm font-medium mb-1">å¯†ç </label>
          <input type="password" id="login-password" placeholder="è¯·è¾“å…¥å¯†ç " 
                class="w-full bg-neutral-100 dark:bg-neutral-700/50 border border-neutral-200 dark:border-neutral-600/50 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-primary/50 text-sm shadow-sm">
        </div>
        
        <div class="flex justify-between items-center">
          <label class="flex items-center">
            <input type="checkbox" id="remember-me" class="mr-2 rounded text-primary focus:ring-primary">
            <span class="text-sm text-neutral-600 dark:text-neutral-400">è®°ä½æˆ‘</span>
          </label>
          <button id="forgot-password" class="text-sm text-primary hover:text-primary/80">å¿˜è®°å¯†ç ?</button>
        </div>
        
        <button id="login-btn" class="w-full bg-primary hover:bg-primary/90 text-white py-3 rounded-lg transition-colors hover:scale-[1.02] transition-transform shadow-md font-medium">
          ç™»å½•
        </button>
        
        <div class="relative text-center">
          <div class="absolute inset-0 flex items-center">
            <div class="w-full border-t border-neutral-200 dark:border-neutral-700"></div>
          </div>
          <div class="relative z-10">
            <span class="px-2 bg-white dark:bg-neutral-800 text-sm text-neutral-500 dark:text-neutral-400">æˆ–è€…</span>
          </div>
        </div>
        
        <button id="register-btn" class="w-full bg-transparent border border-primary text-primary hover:bg-primary/10 py-3 rounded-lg transition-colors hover:scale-[1.02] transition-transform shadow-sm font-medium">
          æ³¨å†Œæ–°è´¦å·
        </button>
      </div>
    </div>
  </div>

  <!-- æ³¨å†Œæ¨¡æ€æ¡† -->
  <div id="register-modal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-neutral-800 rounded-xl w-full max-w-md mx-4 p-6 border border-neutral-200 dark:border-neutral-700/50 shadow-2xl animate-fade-in">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-lg">åˆ›å»ºæ–°è´¦å·</h3>
        <button id="close-register-modal" class="p-2 text-neutral-500 dark:text-neutral-400 hover:text-neutral-800 dark:hover:text-white hover:scale-110 transition-transform">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <div class="space-y-4">
        <div>
          <label for="register-nickname" class="block text-sm font-medium mb-1">æ˜µç§°</label>
          <input type="text" id="register-nickname" placeholder="è¯·è¾“å…¥æ˜µç§° (1-10ä¸ªå­—ç¬¦)" 
                class="w-full bg-neutral-100 dark:bg-neutral-700/50 border border-neutral-200 dark:border-neutral-600/50 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-primary/50 text-sm shadow-sm">
          <p id="nickname-error" class="text-xs text-red-500 mt-1 hidden">æ˜µç§°é•¿åº¦ä¸ç¬¦åˆè¦æ±‚</p>
        </div>
        
        <div>
          <label for="register-userid" class="block text-sm font-medium mb-1">ç”¨æˆ·ID</label>
          <div class="relative">
            <input type="text" id="register-userid" placeholder="è¯·è¾“å…¥ç”¨æˆ·ID (3-20ä¸ªå­—ç¬¦ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿)" 
                  class="w-full bg-neutral-100 dark:bg-neutral-700/50 border border-neutral-200 dark:border-neutral-600/50 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-primary/50 text-sm shadow-sm pr-10">
            <button id="check-userid-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-neutral-400 hover:text-primary">
              <i class="fa fa-check-circle"></i>
            </button>
          </div>
          <p id="userid-error" class="text-xs text-red-500 mt-1 hidden">ç”¨æˆ·IDä¸ç¬¦åˆè¦æ±‚</p>
          <p id="userid-exists" class="text-xs text-red-500 mt-1 hidden">è¯¥ç”¨æˆ·IDå·²å­˜åœ¨</p>
          <p id="userid-available" class="text-xs text-green-500 mt-1 hidden">è¯¥ç”¨æˆ·IDå¯ç”¨</p>
        </div>
        
        <div>
          <label for="register-password" class="block text-sm font-medium mb-1">å¯†ç </label>
          <input type="password" id="register-password" placeholder="è¯·è¾“å…¥å¯†ç  (è‡³å°‘6ä¸ªå­—ç¬¦)" 
                class="w-full bg-neutral-100 dark:bg-neutral-700/50 border border-neutral-200 dark:border-neutral-600/50 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-primary/50 text-sm shadow-sm">
          <p id="password-error" class="text-xs text-red-500 mt-1 hidden">å¯†ç é•¿åº¦ä¸è¶³</p>
        </div>
        
        <div>
          <label for="register-confirm-password" class="block text-sm font-medium mb-1">ç¡®è®¤å¯†ç </label>
          <input type="password" id="register-confirm-password" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " 
                class="w-full bg-neutral-100 dark:bg-neutral-700/50 border border-neutral-200 dark:border-neutral-600/50 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-primary/50 text-sm shadow-sm">
          <p id="confirm-password-error" class="text-xs text-red-500 mt-1 hidden">ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´</p>
        </div>
        
        <button id="create-account-btn" class="w-full bg-primary hover:bg-primary/90 text-white py-3 rounded-lg transition-colors hover:scale-[1.02] transition-transform shadow-md font-medium disabled:opacity-50" disabled>
          åˆ›å»ºè´¦å·
        </button>
      </div>
    </div>
  </div>

  <!-- ç”¨æˆ·èµ„æ–™æ¨¡æ€æ¡† -->
  <div id="user-profile-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-neutral-800 rounded-xl w-full max-w-md mx-4 p-6 border border-neutral-200 dark:border-neutral-700/50 shadow-xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-lg">ç”¨æˆ·èµ„æ–™</h3>
        <button id="close-user-profile-modal" class="p-2 text-neutral-500 dark:text-neutral-400 hover:text-neutral-800 dark:hover:text-white hover:scale-110 transition-transform">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <div class="text-center mb-4">
        <div class="w-20 h-20 mx-auto rounded-full bg-primary/20 flex items-center justify-center shadow-md">
          <i class="fa fa-user-circle text-primary text-3xl"></i>
        </div>
        <h4 id="profile-nickname" class="font-bold text-lg mt-2"></h4>
        <p id="profile-userid" class="text-sm text-neutral-500 dark:text-neutral-400">ç”¨æˆ·ID: <span></span></p>
      </div>
      
      <div class="space-y-3">
        <div class="flex justify-between items-center p-3 bg-neutral-100 dark:bg-neutral-700/50 rounded-lg">
          <span>æ³¨å†Œæ—¶é—´</span>
          <span id="profile-created-at" class="text-sm"></span>
        </div>
        
        <div class="flex justify-between items-center p-3 bg-neutral-100 dark:bg-neutral-700/50 rounded-lg">
          <span>æœ€ååœ¨çº¿</span>
          <span id="profile-last-active" class="text-sm"></span>
        </div>
        
        <button id="add-friend-btn" class="w-full mt-4 bg-primary hover:bg-primary/90 text-white py-2 rounded-lg transition-colors hover:scale-[1.02] transition-transform shadow-sm">
          <i class="fa fa-plus-circle mr-1"></i> æ·»åŠ å¥½å‹
        </button>
        
        <button id="start-private-chat-btn" class="w-full mt-2 bg-accent hover:bg-accent/90 text-white py-2 rounded-lg transition-colors hover:scale-[1.02] transition-transform shadow-sm">
          <i class="fa fa-commenting-o mr-1"></i> å¼€å§‹ç§èŠ
        </button>
      </div>
    </div>
  </div>

  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <header class="sticky top-0 z-50 bg-white/80 dark:bg-neutral-900/80 glass border-b border-neutral-200 dark:border-neutral-700/50 shadow-sm">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <div class="w-8 h-8 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center shadow-sm">
          <i class="fa fa-paper-plane text-white text-sm"></i>
        </div>
        <h1 class="text-xl font-bold bg-gradient-to-r from-primary to-secondary inline-block text-transparent bg-clip-text text-shadow">å°ç™½ä¿¡</h1>
      </div>
      
      <div class="flex items-center space-x-4">
        <div class="hidden md:flex items-center space-x-1 text-sm text-neutral-500 dark:text-neutral-400">
          <i class="fa fa-users"></i>
          <span id="online-count">0</span>
          <span class="text-neutral-500 dark:text-neutral-500">ä½åœ¨çº¿</span>
        </div>
        <button id="logout-btn" class="text-sm text-primary hover:text-primary/80 flex items-center hidden">
          <i class="fa fa-sign-out mr-1"></i> é€€å‡º
        </button>
        <button id="theme-toggle" class="p-2 rounded-full hover:bg-neutral-200 dark:hover:bg-neutral-700/50 transition-colors">
          <i class="fa fa-moon-o dark:hidden"></i>
          <i class="fa fa-sun-o hidden dark:inline-block"></i>
        </button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6 flex flex-col md:flex-row gap-6">
    <!-- ä¸»é¢˜æˆ¿é—´åˆ—è¡¨ (ç§»åŠ¨ç«¯éšè—) -->
    <aside class="w-full md:w-64 hidden md:block">
      <div class="bg-white/80 dark:bg-neutral-800/80 glass rounded-xl p-4 border border-neutral-200 dark:border-neutral-700/50 shadow-sm hover-scale">
        <h2 class="font-bold text-lg mb-4 flex items-center">
          <i class="fa fa-th-large text-primary mr-2"></i>
          ä¸»é¢˜æˆ¿é—´
        </h2>
        
        <div class="space-y-2" id="room-list">
          <!-- æˆ¿é—´åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
      
      <!-- å¥½å‹åˆ—è¡¨ -->
      <div class="bg-white/80 dark:bg-neutral-800/80 glass rounded-xl p-4 border border-neutral-200 dark:border-neutral-700/50 shadow-sm hover-scale mt-4">
        <h2 class="font-bold text-lg mb-4 flex items-center">
          <i class="fa fa-users text-primary mr-2"></i>
          æˆ‘çš„å¥½å‹
        </h2>
        
        <div class="space-y-2" id="friends-list">
          <!-- å¥½å‹åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
          <div class="text-center text-neutral-400 text-xs py-2">
            æš‚æ— å¥½å‹
          </div>
        </div>
      </div>
    </aside>

    <!-- èŠå¤©ä¸»åŒºåŸŸ -->
    <section class="flex-1 flex flex-col">
      <!-- å½“å‰æˆ¿é—´ä¿¡æ¯ -->
      <div class="bg-white/80 dark:bg-neutral-800/80 glass rounded-t-xl p-4 border-x border-t border-neutral-200 dark:border-neutral-700/50 shadow-sm">
        <div class="flex items-center justify-center">
          <div class="text-center">
            <h2 id="current-room" class="font-bold text-lg text-shadow">ä¸‹ç­åé—²èŠ</h2>
            <p id="room-desc" class="text-sm text-neutral-600 dark:text-neutral-300">èŠèŠä»Šå¤©å·¥ä½œä¸­çš„è¶£äº‹æˆ–çƒ¦æ¼</p>
          </div>
        </div>
      </div>
      
      <!-- æ¶ˆæ¯åˆ—è¡¨ -->
      <div id="message-container" class="flex-1 bg-white/60 dark:bg-neutral-900/60 glass border-x border-neutral-200 dark:border-neutral-700/50 overflow-y-auto scrollbar-hide p-4 space-y-4 scroll-smooth">
        <!-- æ¬¢è¿æ¶ˆæ¯ -->
        <div class="text-center py-6 text-neutral-600 dark:text-neutral-300 bg-darken rounded-xl">
          <div class="w-16 h-16 mx-auto mb-2 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center shadow-md">
            <i class="fa fa-comments text-white text-2xl"></i>
          </div>
          <p class="font-medium">æ¬¢è¿ä½¿ç”¨ <span class="font-bold text-primary">å°ç™½ä¿¡</span></p>
          <p class="text-sm mt-1">è¯·æ–‡æ˜å‘è¨€ï¼Œéµå®ˆç¤¾åŒºè§„åˆ™</p>
        </div>
        
        <!-- æ¶ˆæ¯å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
      </div>
      
      <!-- è¾“å…¥åŒºåŸŸ -->
      <div class="bg-white/80 dark:bg-neutral-800/80 glass rounded-b-xl p-4 border-x border-b border-neutral-200 dark:border-neutral-700/50 shadow-sm">
        <div class="flex items-end space-x-2 mb-3">
          <!-- æ–‡ä»¶ä¸Šä¼ æŒ‰é’® -->
          <label for="file-upload" class="p-2 text-neutral-500 dark:text-neutral-400 hover:text-primary dark:hover:text-primary hover:scale-110 transition-transform cursor-pointer">
            <i class="fa fa-paperclip"></i>
            <input type="file" id="file-upload" class="hidden" accept="*">
          </label>
          
          <!-- è¡¨æƒ…åŒ…æŒ‰é’® -->
          <button id="emoji-btn" class="p-2 text-neutral-500 dark:text-neutral-400 hover:text-primary dark:hover:text-primary hover:scale-110 transition-transform">
            <i class="fa fa-smile-o"></i>
          </button>
          
          <!-- è‡ªå®šä¹‰è¡¨æƒ…åŒ…æŒ‰é’® -->
          <button id="custom-emoji-btn" class="p-2 text-neutral-500 dark:text-neutral-400 hover:text-primary dark:hover:text-primary hover:scale-110 transition-transform">
            <i class="fa fa-image"></i>
          </button>
          
          <!-- è¾“å…¥æ¡† -->
          <div class="flex-1 relative">
            <textarea id="message-input" placeholder="è¯·å…ˆç™»å½•å†å‘è¨€..." class="w-full bg-neutral-100 dark:bg-neutral-700/50 border border-neutral-200 dark:border-neutral-600/50 rounded-2xl py-2 px-4 focus:outline-none focus:ring-2 focus:ring-primary/50 text-sm shadow-sm resize-none min-h-[40px]" style="max-height: 120px;" disabled></textarea>
            
            <!-- å›¾ç‰‡é¢„è§ˆ -->
            <div id="image-preview" class="hidden mt-2 grid grid-cols-3 gap-2">
              <!-- é¢„è§ˆå›¾å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
          
          <!-- å‘é€æŒ‰é’® -->
          <button id="send-btn" class="p-3 bg-gray-400 text-white rounded-full transition-colors shadow-sm cursor-not-allowed" disabled>
            <i class="fa fa-paper-plane"></i>
          </button>
        </div>
        
        <!-- ç™»å½•æç¤º -->
        <div id="login-prompt" class="mt-3 text-sm text-neutral-500 dark:text-neutral-400 text-center">
          <span>è¯· <button id="login-prompt-btn" class="text-primary hover:text-primary/80 hover:underline">ç™»å½•</button> åå¼€å§‹èŠå¤©</span>
        </div>
      </div>
    </section>
  </main>

  <!-- ç‰ˆæƒä¿¡æ¯ -->
  <footer class="mt-6 text-center text-xs text-neutral-500 dark:text-neutral-400 pb-4">
    <p>Â© 2025 å…”å°ç™½å·¥ä½œå®¤ Â· ç‰ˆæƒæ‰€æœ‰</p>
  </footer>

  <!-- ç§»åŠ¨ç«¯æˆ¿é—´é€‰æ‹©æ¨¡æ€æ¡† -->
  <div id="room-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-neutral-800 rounded-xl w-full max-w-md mx-4 p-6 border border-neutral-200 dark:border-neutral-700/50 shadow-xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-lg">é€‰æ‹©ä¸»é¢˜æˆ¿é—´</h3>
        <button id="close-modal" class="p-2 text-neutral-500 dark:text-neutral-400 hover:text-neutral-800 dark:hover:text-white hover:scale-110 transition-transform">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <div class="space-y-3 max-h-80 overflow-y-auto" id="mobile-room-list">
        <!-- æˆ¿é—´åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>
  </div>

  <!-- æ›´æ”¹æ˜µç§°æ¨¡æ€æ¡† -->
  <div id="nickname-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-neutral-800 rounded-xl w-full max-w-md mx-4 p-6 border border-neutral-200 dark:border-neutral-700/50 shadow-xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-lg">è®¾ç½®ä½ çš„æ˜µç§°</h3>
        <button id="close-nickname-modal" class="p-2 text-neutral-500 dark:text-neutral-400 hover:text-neutral-800 dark:hover:text-white hover:scale-110 transition-transform">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <div class="space-y-4">
        <p class="text-neutral-600 dark:text-neutral-400 text-sm">è¯·è¾“å…¥ä¸€ä¸ªæ˜µç§°ï¼Œæ–¹ä¾¿å…¶ä»–ç”¨æˆ·è®¤è¯†ä½ </p>
        <input type="text" id="nickname-input" placeholder="è¾“å…¥æ˜µç§° (æœ€å¤š10ä¸ªå­—ç¬¦)" maxlength="10" 
              class="w-full bg-neutral-100 dark:bg-neutral-700/50 border border-neutral-200 dark:border-neutral-600/50 rounded-lg py-2 px-3 focus:outline-none focus:ring-2 focus:ring-primary/50 text-sm shadow-sm">
        <button id="save-nickname" class="w-full bg-primary hover:bg-primary/90 text-white py-2 rounded-lg transition-colors hover:scale-[1.02] transition-transform shadow-sm">
          ä¿å­˜
        </button>
      </div>
    </div>
  </div>

  <!-- Emojié€‰æ‹©å™¨ -->
  <div id="emoji-picker" class="fixed bottom-40 right-4 bg-white dark:bg-neutral-800 rounded-xl p-3 border border-neutral-200 dark:border-neutral-700/50 shadow-lg hidden animate-fade-in glass w-64">
    <div class="grid grid-cols-8 gap-2">
      <button class="emoji-btn p-2 hover:bg-neutral-100 dark:hover:bg-neutral-700/50 rounded-full hover:scale-125 transition-transform">ğŸ˜„</button>
      <button class="emoji-btn p-2 hover:bg-neutral-100 dark:hover:bg-neutral-700/50 rounded-full hover:scale-125 transition-transform">ğŸ˜‚</button>
      <button class="emoji-btn p-2 hover:bg-neutral-100 dark:hover:bg-neutral-700/50 rounded-full hover:scale-125 transition-transform">ğŸ˜Š</button>
      <button class="emoji-btn p-2 hover:bg-neutral-100 dark:hover:bg-neutral-700/50 rounded-full hover:scale-125 transition-transform">ğŸ˜</button>
      <button class="emoji-btn p-2 hover:bg-neutral-100 dark:hover:bg-neutral-700/50 rounded-full hover:scale-125 transition-transform">ğŸ¤”</button>
      <button class="emoji-btn p-2 hover:bg-neutral-100 dark:hover:bg-neutral-700/50 rounded-full hover:scale-125 transition-transform">ğŸ˜</button>
      <button class="emoji-btn p-2 hover:bg-neutral-100 dark:hover:bg-neutral-700/50 rounded-full hover:scale-125 transition-transform">ğŸ¥³</button>
      <button class="emoji-btn p-2 hover:bg-neutral-100 dark:hover:bg-neutral-700/50 rounded-full hover:scale-125 transition-transform">ğŸ¤—</button>
      <button class="emoji-btn p-2 hover:bg-neutral-100 dark:hover:bg-neutral-700/50 rounded-full hover:scale-125 transition-transform">ğŸ˜´</button>
      <button class="emoji-btn p-2 hover:bg-neutral-100 dark:hover:bg-neutral-700/50 rounded-full hover:scale-125 transition-transform">ğŸ˜¡</button>
      <button class="emoji-btn p-2 hover:bg-neutral-100 dark:hover:bg-neutral-700/50 rounded-full hover:scale-125 transition-transform">ğŸ¥º</button>
      <button class="emoji-btn p-2 hover:bg-neutral-100 dark:hover:bg-neutral-700/50 rounded-full hover:scale-125 transition-transform">ğŸ¤¯</button>
      <button class="emoji-btn p-2 hover:bg-neutral-100 dark:hover:bg-neutral-700/50 rounded-full hover:scale-125 transition-transform">ğŸ‘</button>
      <button class="emoji-btn p-2 hover:bg-neutral-100 dark:hover:bg-neutral-700/50 rounded-full hover:scale-125 transition-transform">ğŸ‘</button>
      <button class="emoji-btn p-2 hover:bg-neutral-100 dark:hover:bg-neutral-700/50 rounded-full hover:scale-125 transition-transform">ğŸ‘€</button>
      <button class="emoji-btn p-2 hover:bg-neutral-100 dark:hover:bg-neutral-700/50 rounded-full hover:scale-125 transition-transform">ğŸ’¤</button>
    </div>
  </div>

  <!-- è‡ªå®šä¹‰è¡¨æƒ…åŒ…ä¸Šä¼ æ¨¡æ€æ¡† -->
  <div id="custom-emoji-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
    <div class="bg-white dark:bg-neutral-800 rounded-xl w-full max-w-md mx-4 p-6 border border-neutral-200 dark:border-neutral-700/50 shadow-xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-lg">ä¸Šä¼ è‡ªå®šä¹‰è¡¨æƒ…åŒ…</h3>
        <button id="close-custom-emoji-modal" class="p-2 text-neutral-500 dark:text-neutral-400 hover:text-neutral-800 dark:hover:text-white hover:scale-110 transition-transform">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <div class="space-y-4">
        <div class="text-center p-6 border-2 border-dashed border-neutral-300 dark:border-neutral-600 rounded-lg cursor-pointer hover:border-primary dark:hover:border-primary transition-colors">
          <label for="custom-emoji-upload" class="cursor-pointer">
            <i class="fa fa-cloud-upload text-3xl text-neutral-400 mb-2"></i>
            <p class="text-sm">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p>
            <p class="text-xs text-neutral-500 dark:text-neutral-400 mt-1">æ”¯æŒ JPG, PNG, GIF æ ¼å¼ï¼Œæœ€å¤§ 2MB</p>
            <input type="file" id="custom-emoji-upload" class="hidden" accept="image/*">
          </label>
        </div>
        
        <div id="custom-emoji-preview" class="hidden">
          <h4 class="font-medium mb-2">é¢„è§ˆ</h4>
          <div class="w-full h-48 bg-neutral-100 dark:bg-neutral-700 rounded-lg flex items-center justify-center overflow-hidden">
            <img id="custom-emoji-image" src="" alt="è‡ªå®šä¹‰è¡¨æƒ…åŒ…é¢„è§ˆ" class="max-w-full max-h-full">
          </div>
        </div>
        
        <button id="save-custom-emoji" class="w-full bg-primary hover:bg-primary/90 text-white py-2 rounded-lg transition-colors hover:scale-[1.02] transition-transform shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">
          ä¿å­˜è¡¨æƒ…åŒ…
        </button>
      </div>
    </div>
  </div>

  <!-- è‡ªå®šä¹‰è¡¨æƒ…åŒ…é€‰æ‹©å™¨ -->
  <div id="custom-emoji-picker" class="fixed bottom-40 right-4 bg-white dark:bg-neutral-800 rounded-xl p-3 border border-neutral-200 dark:border-neutral-700/50 shadow-lg hidden animate-fade-in glass w-64">
    <div class="flex justify-between items-center mb-2">
      <h4 class="text-sm font-medium">è‡ªå®šä¹‰è¡¨æƒ…åŒ…</h4>
      <button id="add-custom-emoji" class="text-xs text-primary hover:text-primary/80">
        <i class="fa fa-plus-circle"></i> æ·»åŠ 
      </button>
    </div>
    <div class="grid grid-cols-4 gap-2" id="custom-emoji-list">
      <!-- è‡ªå®šä¹‰è¡¨æƒ…åŒ…å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
      <div class="text-center text-neutral-400 text-xs col-span-4 py-3">
        æš‚æ— è‡ªå®šä¹‰è¡¨æƒ…åŒ…
      </div>
    </div>
  </div>

  <script>
    // åˆå§‹åŒ–LeanCloudï¼ˆå·²å¡«å…¥ä½ çš„é…ç½®ï¼‰
    const APP_ID = '7TkKVrelDpTPcaoBG1M8ivcR-gzGzoHsz';
    const APP_KEY = '8doPOenPUVf7Lh48amsxfMSI';
    const SERVER_URL = 'https://7tkkvrel.lc-cn-n1-shared.com';
    
    AV.init({
      appId: APP_ID,
      appKey: APP_KEY,
      serverURL: SERVER_URL
    });
    
    // æˆ¿é—´æ•°æ®
    const rooms = [
      { id: 'general', name: 'é—²èŠå¤§å…', desc: 'å’Œå¤§å®¶ä¸€èµ·ç•…èŠå„ç§è¯é¢˜', icon: 'fa-coffee' },
      { id: 'study', name: 'å­¦ä¹ äº’åŠ©', desc: 'ä¸€èµ·è®¨è®ºå­¦ä¹ é—®é¢˜ï¼Œäº’ç›¸å¸®åŠ©', icon: 'fa-book' },
      { id: 'game', name: 'æ¸¸æˆå¼€é»‘', desc: 'æ‰¾é˜Ÿå‹ä¸€èµ·ç©æ¸¸æˆï¼Œè®¨è®ºæ–°å‡ºçš„æ¸¸æˆ', icon: 'fa-gamepad' },
      { id: 'music', name: 'éŸ³ä¹äº¤æµ', desc: 'æ¨èå¥½å¬çš„æ­Œæ›²ï¼Œåˆ†äº«éŸ³ä¹èƒŒåçš„æ•…äº‹', icon: 'fa-music' },
      { id: 'interest', name: 'å…´è¶£çˆ±å¥½', desc: 'åˆ†äº«ä½ çš„å…´è¶£çˆ±å¥½ï¼Œæ‰¾åˆ°å¿—åŒé“åˆçš„æœ‹å‹', icon: 'fa-paint-brush' }
    ];
    
    // å…¨å±€å˜é‡
    let currentUser = null;
    let messageQuery;
    let userQuery;
    let messageSubscription;
    let userSubscription;
    let pendingFiles = []; // å¾…å‘é€çš„æ–‡ä»¶
    let customEmojis = []; // è‡ªå®šä¹‰è¡¨æƒ…åŒ…
    
    // ç”Ÿæˆéšæœºç”¨æˆ·ID
    function generateUserId() {
      return 'user_' + Math.random().toString(36).substr(2, 9);
    }
    
    // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
    function escapeHTML(str) {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
    
    // åˆå§‹åŒ–é¡µé¢
    document.addEventListener('DOMContentLoaded', () => {
      initRooms();
      setupEventListeners();
      loadNicknameFromStorage();
      loadCustomEmojis();
      checkDarkMode();
      
      // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
      const savedUser = localStorage.getItem('chatAppUser');
      if (savedUser) {
        try {
          currentUser = JSON.parse(savedUser);
          if (!currentUser.room) currentUser.room = 'general';
          joinRoom(currentUser.room);
          document.getElementById('login-modal').classList.add('hidden');
          document.getElementById('message-input').disabled = false;
          document.getElementById('send-btn').disabled = false;
          document.getElementById('send-btn').classList.remove('bg-gray-400');
          document.getElementById('send-btn').classList.add('bg-primary');
          document.getElementById('login-prompt').classList.add('hidden');
          document.getElementById('logout-btn').classList.remove('hidden');
          document.getElementById('current-nickname').textContent = currentUser.nickname;
        } catch (e) {
          console.error('è§£æç”¨æˆ·æ•°æ®å¤±è´¥:', e);
          showLoginModal();
        }
      } else {
        showLoginModal();
      }
    });
    
    // æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
    function showLoginModal() {
      document.getElementById('login-modal').classList.remove('hidden');
      document.getElementById('login-userid').focus();
    }
    
    // æ£€æŸ¥å¹¶è®¾ç½®æš—é»‘æ¨¡å¼
    function checkDarkMode() {
      if (localStorage.getItem('darkMode') === 'true' || 
          (localStorage.getItem('darkMode') === null && 
           window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.body.classList.add('dark');
      }
    }
    
    // åˆå§‹åŒ–æˆ¿é—´åˆ—è¡¨
    function initRooms() {
      const roomList = document.getElementById('room-list');
      const mobileRoomList = document.getElementById('mobile-room-list');
      
      rooms.forEach(room => {
        // æ¡Œé¢ç‰ˆæˆ¿é—´åˆ—è¡¨
        const roomItem = document.createElement('div');
        roomItem.className = `p-3 rounded-xl hover:bg-neutral-100 dark:hover:bg-neutral-700/50 cursor-pointer transition-colors flex items-center 
                             ${currentUser && room.id === currentUser.room ? 'bg-neutral-100 dark:bg-neutral-700/50 border-l-4 border-primary' : ''}`;
        roomItem.innerHTML = `
          <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center mr-3">
            <i class="fa ${room.icon} text-primary"></i>
          </div>
          <div>
            <div class="font-medium">${room.name}</div>
            <div class="text-xs text-neutral-500 dark:text-neutral-400">${room.desc}</div>
          </div>
        `;
        roomItem.addEventListener('click', () => joinRoom(room.id));
        roomList.appendChild(roomItem);
        
        // ç§»åŠ¨ç‰ˆæˆ¿é—´åˆ—è¡¨
        const mobileRoomItem = document.createElement('div');
        mobileRoomItem.className = `p-3 rounded-xl hover:bg-neutral-100 dark:hover:bg-neutral-700/50 cursor-pointer transition-colors flex items-center 
                                  ${currentUser && room.id === currentUser.room ? 'bg-neutral-100 dark:bg-neutral-700/50 border-l-4 border-primary' : ''}`;
        mobileRoomItem.innerHTML = `
          <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center mr-3">
            <i class="fa ${room.icon} text-primary"></i>
          </div>
          <div>
            <div class="font-medium">${room.name}</div>
            <div class="text-sm text-neutral-500 dark:text-neutral-400">${room.desc}</div>
          </div>
        `;
        mobileRoomItem.addEventListener('click', () => {
          joinRoom(room.id);
          document.getElementById('room-modal').classList.add('hidden');
        });
        mobileRoomList.appendChild(mobileRoomItem);
      });
    }
    
    // åŠ å…¥æˆ¿é—´
    function joinRoom(roomId) {
      if (!currentUser) {
        showLoginModal();
        return;
      }
      
      // ç¦»å¼€å½“å‰æˆ¿é—´
      if (messageSubscription) messageSubscription.unsubscribe();
      if (userSubscription) userSubscription.unsubscribe();
      
      // æ›´æ–°å½“å‰æˆ¿é—´
      const room = rooms.find(r => r.id === roomId);
      if (!room) return;
      
      currentUser.room = roomId;
      document.getElementById('current-room').textContent = room.name;
      document.getElementById('room-desc').textContent = room.desc;
      
      // æ›´æ–°æˆ¿é—´åˆ—è¡¨é€‰ä¸­çŠ¶æ€
      updateRoomSelection(roomId);
      
      // æ¸…ç©ºæ¶ˆæ¯å®¹å™¨
      const messageContainer = document.getElementById('message-container');
      messageContainer.innerHTML = '';
      
      // æ·»åŠ åŠ è½½æç¤º
      const loadingIndicator = document.createElement('div');
      loadingIndicator.className = 'text-center py-4 text-neutral-500 dark:text-neutral-400';
      loadingIndicator.innerHTML = '<i class="fa fa-circle-o-notch fa-spin"></i> åŠ è½½ä¸­...';
      messageContainer.appendChild(loadingIndicator);
      
      // æŸ¥è¯¢æ¶ˆæ¯
      const Message = AV.Object.extend(`ChatMessage_${roomId}`);
      messageQuery = new AV.Query(Message);
      messageQuery.limit(100);
      messageQuery.ascending('createdAt');
      
      // è®¢é˜…æ¶ˆæ¯å˜åŒ–
      messageQuery.find().then(messages => {
        messageContainer.innerHTML = '';
        messages.forEach(msg => {
          addMessageToUI(msg.toJSON());
        });
        scrollToBottom();
        
        // è®¢é˜…å®æ—¶æ¶ˆæ¯
        messageSubscription = messageQuery.subscribe();
        messageSubscription.on('create', msg => {
          addMessageToUI(msg.toJSON());
          scrollToBottom();
        });
      }).catch(error => {
        console.error('è·å–æ¶ˆæ¯å¤±è´¥:', error);
        messageContainer.innerHTML = '<div class="text-center py-4 text-red-500">åŠ è½½æ¶ˆæ¯å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</div>';
      });
      
      // è®°å½•ç”¨æˆ·åœ¨çº¿çŠ¶æ€
      const User = AV.Object.extend(`OnlineUsers_${roomId}`);
      const userObj = new User();
      userObj.set('userId', currentUser.id);
      userObj.set('nickname', currentUser.nickname);
      userObj.save().then(savedUser => {
        // è®¾ç½®åœ¨çº¿ç”¨æˆ·ç›‘å¬
        userQuery = new AV.Query(User);
        
        // å®šæœŸæ›´æ–°ç”¨æˆ·åœ¨çº¿çŠ¶æ€
        setInterval(() => {
          savedUser.set('lastActive', new Date());
          savedUser.save();
        }, 30000);
      });
      
      // ç›‘å¬åœ¨çº¿ç”¨æˆ·å˜åŒ–
      updateOnlineCount(roomId);
      setInterval(() => updateOnlineCount(roomId), 10000);
      
      // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
      localStorage.setItem('chatAppUser', JSON.stringify({
        id: currentUser.id,
        nickname: currentUser.nickname,
        room: currentUser.room
      }));
    }
    
    // æ›´æ–°æˆ¿é—´é€‰æ‹©çŠ¶æ€
    function updateRoomSelection(roomId) {
      const roomItems = document.querySelectorAll('#room-list > div');
      const mobileRoomItems = document.querySelectorAll('#mobile-room-list > div');
      
      rooms.forEach((room, index) => {
        const isSelected = room.id === roomId;
        roomItems[index].className = `p-3 rounded-xl hover:bg-neutral-100 dark:hover:bg-neutral-700/50 cursor-pointer transition-colors flex items-center 
                                    ${isSelected ? 'bg-neutral-100 dark:bg-neutral-700/50 border-l-4 border-primary' : ''}`;
        mobileRoomItems[index].className = `p-3 rounded-xl hover:bg-neutral-100 dark:hover:bg-neutral-700/50 cursor-pointer transition-colors flex items-center 
                                          ${isSelected ? 'bg-neutral-100 dark:bg-neutral-700/50 border-l-4 border-primary' : ''}`;
      });
    }
    
    // æ›´æ–°åœ¨çº¿äººæ•°
    function updateOnlineCount(roomId) {
      const User = AV.Object.extend(`OnlineUsers_${roomId}`);
      const query = new AV.Query(User);
      
      // åªè®¡ç®—æœ€è¿‘1åˆ†é’Ÿæ´»è·ƒçš„ç”¨æˆ·
      const oneMinuteAgo = new Date();
      oneMinuteAgo.setMinutes(oneMinuteAgo.getMinutes() - 1);
      query.greaterThanOrEqualTo('lastActive', oneMinuteAgo);
      
      query.count().then(count => {
        document.getElementById('online-count').textContent = count;
      }).catch(error => {
        console.error('è·å–åœ¨çº¿äººæ•°å¤±è´¥:', error);
      });
    }
    
    // æ·»åŠ æ¶ˆæ¯åˆ°UI
    function addMessageToUI(message) {
      const messageContainer = document.getElementById('message-container');
      const isCurrentUser = message.userId === currentUser?.id;
      
      const msgDiv = document.createElement('div');
      msgDiv.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'} animate-fade-in`;
      
      let bgColor, textColor, bubbleClass;
      if (isCurrentUser) {
        bgColor = 'bg-primary';
        textColor = 'text-white';
        bubbleClass = 'bubble-right';
      } else {
        bgColor = 'bg-neutral-100 dark:bg-neutral-700/50';
        textColor = 'text-neutral-800 dark:text-neutral-100';
        bubbleClass = 'bubble-left';
      }
      
      // è§£ææ¶ˆæ¯å†…å®¹
      let contentHtml = '';
      if (message.type === 'text') {
        // å¤„ç†æ™®é€šæ–‡æœ¬æ¶ˆæ¯
        contentHtml = `<p>${escapeHTML(message.content)}</p>`;
      } else if (message.type === 'image') {
        // å¤„ç†å›¾ç‰‡æ¶ˆæ¯
        contentHtml = `
          <div class="relative">
            <img src="${message.url}" alt="å›¾ç‰‡æ¶ˆæ¯" class="max-w-[200px] rounded-lg hover:scale-110 transition-transform cursor-zoom-in">
          </div>
        `;
      } else if (message.type === 'system') {
        // å¤„ç†ç³»ç»Ÿæ¶ˆæ¯
        msgDiv.className = 'flex justify-center animate-fade-in';
        contentHtml = `
          <div class="text-center px-4 py-1 rounded-full bg-neutral-200 dark:bg-neutral-700 text-xs text-neutral-600 dark:text-neutral-300">
            ${escapeHTML(message.content)}
          </div>
        `;
        bgColor = '';
        textColor = '';
        bubbleClass = '';
      }
      
      // æ„å»ºæ¶ˆæ¯HTML
      if (message.type !== 'system') {
        msgDiv.innerHTML = `
          <div class="max-w-[80%]">
            <div class="flex items-center mb-1 ${isCurrentUser ? 'justify-end' : 'justify-start'}">
              ${isCurrentUser ? '' : `<span class="text-xs font-medium text-neutral-500 dark:text-neutral-400">${escapeHTML(message.nickname)}</span>`}
              <span class="text-xs text-neutral-400 dark:text-neutral-500 ml-2">${formatTime(message.createdAt)}</span>
            </div>
            <div class="${bgColor} ${textColor} ${bubbleClass} p-3 shadow-sm">
              ${contentHtml}
            </div>
          </div>
        `;
      } else {
        msgDiv.innerHTML = contentHtml;
      }
      
      messageContainer.appendChild(msgDiv);
    }
    
    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      return `${hours}:${minutes}`;
    }
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    function scrollToBottom() {
      const messageContainer = document.getElementById('message-container');
      messageContainer.scrollTop = messageContainer.scrollHeight;
    }
    
    // å‘é€æ¶ˆæ¯
    function sendMessage(content, type = 'text', url = '') {
      if (!currentUser) {
        showLoginModal();
        return;
      }
      
      if (!content.trim() && type === 'text') return;
      
      const Message = AV.Object.extend(`ChatMessage_${currentUser.room}`);
      const message = new Message();
      
      message.set('userId', currentUser.id);
      message.set('nickname', currentUser.nickname);
      message.set('content', content);
      message.set('type', type);
      if (url) message.set('url', url);
      
      message.save().then(() => {
        if (type === 'text') {
          document.getElementById('message-input').value = '';
        } else if (type === 'image') {
          document.getElementById('image-preview').classList.add('hidden');
          pendingFiles = [];
        }
      }).catch(error => {
        console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
        alert('å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œè¯·é‡è¯•');
      });
    }
    
    // ä¸Šä¼ å›¾ç‰‡
    function uploadImage(file) {
      const name = `image_${Date.now()}.${file.name.split('.').pop()}`;
      const avFile = new AV.File(name, file);
      
      return avFile.save().then(file => {
        return file.url();
      }).catch(error => {
        console.error('ä¸Šä¼ å›¾ç‰‡å¤±è´¥:', error);
        throw error;
      });
    }
    
    // åŠ è½½æœ¬åœ°å­˜å‚¨çš„æ˜µç§°
    function loadNicknameFromStorage() {
      const savedUser = localStorage.getItem('chatAppUser');
      if (savedUser) {